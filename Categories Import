#!/bin/bash
set -eo pipefail

# --- Prerequisite Check ---
if ! command -v curl &> /dev/null; then
    echo "Error: This script requires 'curl'. Please install it to proceed." >&2
    exit 1
fi
if ! command -v jq &> /dev/null; then
    echo "Error: This script requires 'jq'. Please install it to proceed." >&2
    exit 1
fi

echo "--- Jamf Pro 'Category' to Terraform Import Script ---"
echo "This script will generate:"
echo " 1. categories.tf (Permanent HCL code)"
echo " 2. categories_import.tf (Temporary import instructions)"
echo

# --- 1. Get User Credentials ---
read -p "Enter your Jamf Pro URL (e.g., https://myjamf.jamfcloud.com): " JAMF_URL
read -p "Enter your Jamf Pro Client ID: " JAMF_CLIENT_ID
read -sp "Enter your Jamf Pro Client Secret: " JAMF_CLIENT_SECRET
echo # Newline after secret input

JAMF_URL=${JAMF_URL%/}

# --- 2. Authenticate and Get Token ---
echo
echo "Attempting to get auth token from ${JAMF_URL}..."
TOKEN_RESPONSE=$(curl -s -X POST \
  "${JAMF_URL}/api/oauth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "client_id=${JAMF_CLIENT_ID}" \
  -d "client_secret=${JAMF_CLIENT_SECRET}" \
  -d "grant_type=client_credentials")

ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r .access_token)

if [ "$ACCESS_TOKEN" == "null" ] || [ -z "$ACCESS_TOKEN" ]; then
  echo "Error: Failed to get access token." >&2
  echo "Response: $TOKEN_RESPONSE" >&2
  unset JAMF_CLIENT_SECRET
  exit 1
fi
echo "âœ… Successfully authenticated."
echo

unset JAMF_CLIENT_SECRET

# --- 3. Resource Configuration (Hardcoded for Categories) ---
TF_RESOURCE_TYPE="jamfpro_category"
LIST_API_ENDPOINT="/api/v1/categories"
DETAIL_API_ENDPOINT_TEMPLATE="/api/v1/categories/"
LIST_JSON_RESULTS_KEY="results"
LIST_JSON_ID_KEY="id"
LIST_JSON_NAME_KEY="name"
TF_RESOURCE_NAME="imported_categories"
TF_VAR_NAME="categories_map"

# JQ query to filter API JSON into clean Terraform HCL attributes
JQ_TRANSFORM_QUERY="{
  name: .name,
  priority: .priority
}"

# HCL content to go inside the resource block
HCL_RESOURCE_CONTENT=$(cat <<'EOF'
  name     = each.value.name
  priority = each.value.priority
EOF
)

# --- 4. Fetch All Categories (List + Detail Loop) ---
echo "Fetching all categories from ${JAMF_URL}..."
LIST_RESPONSE=$(curl -s -X GET \
  "${JAMF_URL}${LIST_API_ENDPOINT}" \
  -H "Authorization: Bearer ${ACCESS_TOKEN}")

if [ -z "$LIST_RESPONSE" ] || ! echo "$LIST_RESPONSE" | jq -e 'has($key)' --arg key "$LIST_JSON_RESULTS_KEY" > /dev/null; then
    echo "Error: Received empty or invalid response from list endpoint." >&2
    unset ACCESS_TOKEN
    exit 1
fi

ITEM_COUNT=$(echo "$LIST_RESPONSE" | jq -r ".${LIST_JSON_RESULTS_KEY} | length")
if [ "$ITEM_COUNT" -eq 0 ]; then
    echo "No categories found in Jamf Pro. Exiting."
    unset ACCESS_TOKEN
    exit 0
fi
echo "Found ${ITEM_COUNT} categories. Fetching full details..."

FINAL_HCL_MAP="{}"
IMPORT_BLOCKS="" # String to hold all import blocks
PROCESSED_COUNT=0

while read -r item_summary; do
  ITEM_ID=$(echo "$item_summary" | jq -r ".$LIST_JSON_ID_KEY")
  ITEM_NAME=$(echo "$item_summary" | jq -r ".$LIST_JSON_NAME_KEY")
  
  if [ "$ITEM_NAME" == "null" ] || [ -z "$ITEM_NAME" ]; then
    echo "Skipping item with ID $ITEM_ID: Name is missing."
    continue
  fi

  PROCESSED_COUNT=$((PROCESSED_COUNT + 1))
  echo "  ($PROCESSED_COUNT/$ITEM_COUNT) Fetching details for: \"${ITEM_NAME}\" (ID: ${ITEM_ID})"

  DETAIL_RESPONSE=$(curl -s -X GET \
    "${JAMF_URL}${DETAIL_API_ENDPOINT_TEMPLATE}${ITEM_ID}" \
    -H "Authorization: Bearer ${ACCESS_TOKEN}")
    
  if [ -z "$DETAIL_RESPONSE" ] || [ "$(echo "$DETAIL_RESPONSE" | jq -r '.name? // .id?')" == "null" ]; then
    echo "  WARNING: Failed to get details for ID $ITEM_ID. Skipping."
    continue
  fi

  HCL_ATTRIBUTES_JSON=$(echo "$DETAIL_RESPONSE" | jq -c "$JQ_TRANSFORM_QUERY")
  
  if [ -z "$HCL_ATTRIBUTES_JSON" ]; then
    echo "  WARNING: JQ transform failed for ID $ITEM_ID. Skipping."
    continue
  fi

  FINAL_HCL_MAP=$(echo "$FINAL_HCL_MAP" | jq -c \
    --arg key "$ITEM_NAME" \
    --argjson value "$HCL_ATTRIBUTES_JSON" \
    '. + {($key): $value}')

  # Add this item to our string of 'import' blocks
  IMPORT_BLOCKS+=$(printf "import {\n  to = %s.%s[\"%s\"]\n  id = \"%s\"\n}\n\n" \
    "$TF_RESOURCE_TYPE" \
    "$TF_RESOURCE_NAME" \
    "$ITEM_NAME" \
    "$ITEM_ID")

done < <(echo "$LIST_RESPONSE" | jq -c ".${LIST_JSON_RESULTS_KEY}[]")

echo "âœ… All ${PROCESSED_COUNT} items processed."
echo

# --- 5. Generate Permanent HCL File (categories.tf) ---
HCL_FILE="categories.tf"
echo "Generating ${HCL_FILE}..."

{
  echo "# This file was automatically generated by the Jamf import script"
  echo "# This is the permanent configuration file for all categories."
  echo
  echo "locals {"
  echo "  ${TF_VAR_NAME} = $(echo "$FINAL_HCL_MAP" | jq '.')"
  echo "}"
  echo
  echo "resource \"${TF_RESOURCE_TYPE}\" \"${TF_RESOURCE_NAME}\" {"
  echo "  for_each = local.${TF_VAR_NAME}"
  echo
  echo "${HCL_RESOURCE_CONTENT}"
  echo "}"
} > "$HCL_FILE"

# --- 6. Generate Temporary Import File (categories_import.tf) ---
IMPORT_FILE="categories_import.tf"
echo "Generating ${IMPORT_FILE}..."

{
  echo "# This file was automatically generated by the Jamf import script."
  echo "#"
  echo "# This is a TEMPORARY file. DO NOT COMMIT IT."
  echo "#"
  echo "# Run 'terraform apply' to execute these imports, then"
  echo "# DELETE THIS FILE immediately."
  echo
  echo "$IMPORT_BLOCKS"
} > "$IMPORT_FILE"

# --- 7. Final Instructions ---
unset ACCESS_TOKEN # Clear auth token
echo
echo "---"
echo "âœ… Success! Two files have been created:"
echo
echo "1. ${HCL_FILE} (Permanent Code)"
echo "   This is your permanent Terraform code. COMMIT THIS FILE."
echo
echo "2. ${IMPORT_FILE} (Temporary Instructions)"
echo "   This file contains the one-time import blocks. DO NOT COMMIT THIS FILE."
echo
echo "--- ðŸš€ Your (Local) Migration Plan ---"
echo "1. Ensure your Terraform CLI is configured with your PRODUCTION backend."
echo "2. Run 'terraform init'."
echo "3. Run 'terraform plan'. It will show ${PROCESSED_COUNT} resources to import."
echo "4. Run 'terraform apply' to import the resources into your remote state."
echo "5. **DELETE the '${IMPORT_FILE}' file.**"
echo "6. Run 'terraform plan' again. It must now show 'No changes'."
echo "7. Commit 'categories.tf' to Git and open your Pull Request."
echo
echo "Migration generation complete. Good luck!"
