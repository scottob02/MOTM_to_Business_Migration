#!/bin/bash

# ==============================================================================
# SCRIPT: Get Country Code (Dual Redundancy)
# PURPOSE: Retrieves ISO country code (e.g., GB, IN).
#          1. Tries ipinfo.io (Primary)
#          2. Tries ifconfig.co (Fail-over)
#          3. Falls back to local cache if both fail.
# ==============================================================================

# 1. Configuration
# ------------------------------------------------------------------------------
CACHE_FILE="/Library/Application Support/Jamf/addons/org_location_country.txt"
CACHE_DIR=$(dirname "$CACHE_FILE")

# List of verified, working URLs.
# The script will try them in this specific order.
URL_LIST=(
    "https://ipinfo.io/country"
    "https://ifconfig.co/country-iso"
)

# 2. Setup Cache Directory
# ------------------------------------------------------------------------------
# Ensure the directory exists so we can save the file later.
if [[ ! -d "$CACHE_DIR" ]]; then
    mkdir -p "$CACHE_DIR"
fi

# 3. Fetch Logic
# ------------------------------------------------------------------------------
NEW_CODE=""

# Loop through the URLs
for url in "${URL_LIST[@]}"; do
    # -s: Silent (no progress bar)
    # -m 3: Max time 3 seconds per attempt
    # tr -d '[:space:]': Removes any hidden newlines/spaces
    result=$(curl -s -m 3 "$url" | tr -d '[:space:]')
    
    # Validation: We only accept a result if it is exactly 2 characters long (e.g. "US")
    if [[ -n "$result" && ${#result} -eq 2 ]]; then
        NEW_CODE="$result"
        break # We found a working one, exit the loop
    fi
done

# 4. Final Processing & Persistence
# ------------------------------------------------------------------------------
if [[ -n "$NEW_CODE" ]]; then
    # --- SUCCESS ---
    # We got a live result. Update the cache file and set the variable.
    echo "$NEW_CODE" > "$CACHE_FILE"
    RESULT="$NEW_CODE"

else
    # --- FAILURE ---
    # Both URLs failed. Read from the cache file if it exists.
    if [[ -f "$CACHE_FILE" ]]; then
        RESULT=$(cat "$CACHE_FILE")
    else
        # No internet and no previous history.
        RESULT="Unknown"
    fi
fi

# 5. Output to Jamf
# ------------------------------------------------------------------------------
echo "<result>$RESULT</result>"
