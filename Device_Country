#!/bin/bash

# ==============================================================================
# SCRIPT: Get Country Code with Fail-Over Persistence
# PURPOSE: Retrieves the ISO country code (e.g., US, GB, IN) based on IP.
#          Stores the value locally to ensure a result is returned even if offline.
# ==============================================================================

# 1. Configuration Variables
# ------------------------------------------------------------------------------
# We use a hidden file in a shared location so it persists across reboots/users.
CACHE_FILE="/Library/Application Support/Jamf/addons/org_location_country.txt"
CACHE_DIR=$(dirname "$CACHE_FILE")

# The API endpoint. 
# ipapi.co/country is reliable and returns a simple 2-letter text string (e.g., "GB")
# Alternatives if blocked: "https://ipinfo.io/country" or "https://ifconfig.co/country-iso"
API_URL="https://ipapi.co/country/"

# 2. Function to Ensure Cache Directory Exists
# ------------------------------------------------------------------------------
if [[ ! -d "$CACHE_DIR" ]]; then
    mkdir -p "$CACHE_DIR"
fi

# 3. Attempt to fetch current location
# ------------------------------------------------------------------------------
# We use curl with a max time (-m) of 5 seconds so the script doesn't hang forever.
# -s = silent (no progress bar), -f = fail silently on server errors
CURRENT_CODE=$(curl -s -f -m 5 "$API_URL")

# 4. Validate and Process Result
# ------------------------------------------------------------------------------
# Check if we got a valid response (Not empty, and usually 2 chars like 'US' or 'GB')
if [[ -n "$CURRENT_CODE" && ${#CURRENT_CODE} -eq 2 ]]; then
    # --- SUCCESS CASE ---
    # We got a valid code. Update the cache file.
    echo "$CURRENT_CODE" > "$CACHE_FILE"
    RESULT="$CURRENT_CODE"

else
    # --- FAILURE CASE ---
    # The API failed. Check if we have a previously saved value.
    if [[ -f "$CACHE_FILE" ]]; then
        CACHED_VAL=$(cat "$CACHE_FILE")
        # Optional: You can append " (Cached)" if you want to know it's old data,
        # but for pure grouping logic, it's usually better to keep it clean.
        RESULT="$CACHED_VAL"
    else
        # No API access and no previous cache.
        RESULT="Unknown"
    fi
fi

# 5. Output to Jamf
# ------------------------------------------------------------------------------
echo "<result>$RESULT</result>"
