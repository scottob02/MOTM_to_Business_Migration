#!/bin/bash

# ==============================================================================
# SCRIPT: Get Country Code with Dual-API Fail-Over & Persistence
# PURPOSE: Retrieves ISO country code using two different providers to reduce failures.
#          1. Tries ipapi.co
#          2. If that fails, tries ipinfo.io
#          3. If both fail, uses last known cached value.
# ==============================================================================

# 1. Configuration
# ------------------------------------------------------------------------------
CACHE_FILE="/Library/Application Support/Jamf/addons/org_location_country.txt"
CACHE_DIR=$(dirname "$CACHE_FILE")

# Primary API (ipapi)
PRIMARY_URL="https://ipapi.co/country/"

# Secondary API (ipinfo) - Used if Primary fails
# We use this instead of ifconfig.me because we need the Country Code, not the IP.
SECONDARY_URL="https://ipinfo.io/country"

# 2. Setup Cache Directory
# ------------------------------------------------------------------------------
if [[ ! -d "$CACHE_DIR" ]]; then
    mkdir -p "$CACHE_DIR"
fi

# 3. Fetch Data Function
# ------------------------------------------------------------------------------
# We use a function to handle the validation logic easily for both URLs
get_country_code() {
    local url="$1"
    # -s: Silent, -f: Fail fast on server error, -m 3: Max 3 seconds wait
    local result
    result=$(curl -s -f -m 3 "$url" | tr -d '[:space:]') 
    
    # Validation: Check if result is exactly 2 characters (e.g., US, GB, IN)
    if [[ -n "$result" && ${#result} -eq 2 ]]; then
        echo "$result"
        return 0
    else
        return 1
    fi
}

# 4. Execution Logic
# ------------------------------------------------------------------------------

# Attempt 1: Primary URL
NEW_CODE=$(get_country_code "$PRIMARY_URL")

# Attempt 2: Secondary URL (Run only if Primary returned empty)
if [[ -z "$NEW_CODE" ]]; then
    NEW_CODE=$(get_country_code "$SECONDARY_URL")
fi

# 5. Final Processing
# ------------------------------------------------------------------------------

if [[ -n "$NEW_CODE" ]]; then
    # --- SUCCESS ---
    # We got a valid code from either Primary or Secondary. 
    # Update the cache and set the result.
    echo "$NEW_CODE" > "$CACHE_FILE"
    RESULT="$NEW_CODE"

else
    # --- TOTAL FAILURE ---
    # Both APIs failed (likely no internet or strict firewall).
    # Check for a cached value.
    if [[ -f "$CACHE_FILE" ]]; then
        RESULT=$(cat "$CACHE_FILE")
    else
        RESULT="Unknown"
    fi
fi

# 6. Output to Jamf
# ------------------------------------------------------------------------------
echo "<result>$RESULT</result>"
